<!DOCTYPE html>
<html>
<head>
	<title>DCbrain</title>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/echantillons.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='js/multiple-select/multiple-select.css') }}">
</head>

<body>

	{% include 'header.html' %}

	<section>

	<!-- Affichage du message d'erreur d'ouverture -->
		{% if msgErreur is defined %} 
			<h1 id="msgErreur">{{msgErreur}}</h1>
			<form action="{{ url_for('remove', file=file) }}">
  				<input type="submit" style="text-align:center; background-color: red;" class="submit" value="Go Back" id="upload-button1">
			</form>
		
		{% else %} <!-- sinon affichage du contenu du fichier -->

			<!-- nombre de lignes à afficher-->
			{% if lignes == "0" %}
				{% set lignes = request.args.get("nbLignes") %}
			{% endif %}
			{% if lignes == None %}
				{% set lignes = 50 %}
			{% endif %}
	{% set fullLignes = lignes %}
			<!-- si pas de débordements d'affichage (plus de lignes à afficher qu'il y'en a) -->
			{% if (lignesCSV|length - (lignes|int)*(request.args.get("numPage")|int+1)) < 0 %}
				{% set lignes = lignesCSV|length - (lignes|int)*(request.args.get("numPage")|int) %}
			{% endif %}

	<!-- Affichage de la barre de pagination -->
		<div id="pagination">
			<script>
				var lignesJS = parseInt('{{lignes}}');
				var fullLignesJS = parseInt('{{fullLignes}}');
		      	var numPage = parseInt('{{request.args.get("numPage")|int}}');
		       	var ligneDebut = (numPage)*fullLignesJS+1;
		       	var ligneFin = (numPage)*fullLignesJS+lignesJS;
			</script>
			
			<form action="{{ url_for('fenetre_role_choix_colonne',file=file,lignes=0) }}">
			
				<div>	
					<b>Showing rows:</b> <script>document.write(ligneDebut+' - '+ligneFin)</script> / <b>{{lignesCSV|length}}</b> total rows
				</div>

				<div id="pagesMenu">
					<label for="numPage">Page:</label>
					<select name="numPage" id="numPage" onchange="this.form.submit()">
						{% for i in range(((lignesCSV|length)/(lignes|int))|int+1) %}
							<option id="page{{i}}" value="{{i}}">{{i+1}}</option>
						{% endfor %}
			       	</select>
		       	</div>
		       	<div>
		       		<label for="nbLignes">Rows per page:</label>
					<select name="nbLignes" id="nbLignes" onchange="var elemPage0=document.getElementById('page0'); elemPage0.selected=true; this.form.submit();">
						<option id="50" value="50">50</option>
						<option id="500" value="500">500</option>
						<option id="1000" value="1000">1000</option>
						<option id="tous" value="{{lignesCSV|length}}">All file</option>
		       		</select>
		       	</div>
			</form>
		    <script>
	       			var idPage = "page"+numPage;
	       			var elem = document.getElementById(idPage);
	       			elem.selected = true;
	       			var tailleCSV = parseInt('{{lignesCSV|length}}');
					var li50 = document.getElementById('50');
					var li500 = document.getElementById('500');
					var li1000 = document.getElementById('1000');
					var litous = document.getElementById('tous');
					if (tailleCSV < 50){
						li50.disabled = true;
						li500.disabled = true;
						li1000.disabled = true;
					} else if (tailleCSV < 500){
						li500.disabled = true;
						li1000.disabled = true;
					} else if (tailleCSV < 1000)
						li1000.disabled = true;
					if(lignesJS<=50) li50.selected = true;
					else if(lignesJS<=500) li500.selected = true;
					else if(lignesJS<=1000) li1000.selected = true;
					else litous.selected = true;
	       	</script>
		</div>
		
		<!-- Message d'attente tant que le fichier se charge -->
		<div id="loading"><h1 id="loadingText">Loading file, please wait...</h1></div>
		
		<!-- Affichage du contenu du fichier dans une table -->
		<table>
			<!-- Stockage des noms de colonnes modifiables-->
			<script>var nomsColonnes = [];</script>			
			{% for nom in descCSV["nom"] %}
				<script> nomsColonnes.push('{{nom}}'); </script>
			{% endfor %}
			
	<!-- Affichage de la ligne des titres et des boutons de validation -->
			<tr>
				<th><!-- Colonne des numéros et des boutons de filtres --></th>
				<!-- Position de la colonne de date -->
				{% for type in descCSV["type"] %}
					{% if type == "date" %}
						<script>var indexDate = '{{loop.index}}';</script>
					{% endif %}
				{% endfor %}
				
				<!-- Affichage des noms de colonnes + possibilité de modification + envoie analyse -->
				{% for nom in descCSV["nom"] %}
				<th><div contenteditable oninput="nomsColonnes['{{loop.index0}}'] = this.innerHTML.trim();" id="editor">
					{{ nom }}
					</div>
					
					<!-- Bouton de validation pour les colonnes de nombres, avec transmission de données -->
					{% if descCSV["type"][loop.index0] == "nombre" %}
					<input id="btn_analyse" type="submit" Value="Analyse"
							onclick="
									var colonneADD = [];
									var parentADD = [];
									var enfantADD = [];
									var dateADD = [];
									var nomColonne = nomsColonnes['{{loop.index0}}'];
									
									var numLignes = tf_tableCSV.GetColValues(0,true);
									var colonneFiltree = tf_tableCSV.GetColValues('{{loop.index}}',false);
									var dateFiltree = tf_tableCSV.GetColValues(indexDate,false);
									
									//Nettoyage des données dont les lignes contiennet une erreur
									var i;
									for (i = 0 ; i < numLignes.length ; i++){
										var ligneErronee = 0;
										var j;
										for (j = 0; j < lignesErreur.length ; j++){
											if (numLignes[i] == lignesErreur[j]){
												ligneErronee = 1;
											}
										}
										if (ligneErronee == 0){
											colonneADD.push(parseFloat(colonneFiltree[i]));
											dateADD.push(dateFiltree[i]);
										}
									}

									//Envoi des données à analyser
									var file = new Object();
									file.nomColonne = nomColonne;
									file.colonneADD = colonneADD;
									file.dateADD = dateADD;

									$.ajax({
            							url: '/fenetre_resultat_ADD/',
            							type: 'PUT',
            							data: JSON.stringify(file),
            							dataType: 'json',
            							contentType: 'application/json',
            							error: function(jqXHR,textStatus,errorThrown) {
            								console.log(jqXHR);
            								console.log(textStatus);
            								console.log(errorThrown);
            							},
            							success : window.location = '/fenetre_resultat_ADD/' 							      
        							});
									"
					/>
					{% endif %}
				</th>
				{% endfor %}
			</tr>

	<!-- Affichage des filtres -->
			<tr>
				<td> <!-- boutons d'application et de réinitialisation des filtres -->
					<input 	type="image" src="../../static/img/valide.png" Value=submit align="center" width=20px height=20px
							onclick="
									console.log($('#filtresDate').multipleSelect('getSelects'));
									console.log($('#filtresEnfant').multipleSelect('getSelects'));
									console.log($('#filtresParent').multipleSelect('getSelects'));
							"
					"/>
					<input 	type="image" src="../../static/img/supprimer.png" Value=submit align="center" width=20px height=20px
							onclick="
									$('#filtresDate').multipleSelect('uncheckAll');
									$('#filtresEnfant').multipleSelect('uncheckAll');
									$('#filtresParent').multipleSelect('uncheckAll');
							"
					"/>
				</td>
				
				<!-- listes déroulantes de choix de filtres -->
				{% for type in descCSV["type"] %}
				<td>
					{% if type != "nombre" %}
					{% set numColonne = loop.index0 %}
						{% if type == "date" %}
						<select name="filtres" id="filtresDate" multiple="multiple">
						{% elif type == "noeudEnfant" %}
						<select name="filtres" id="filtresEnfant" multiple="multiple">
						{% elif type == "noeudParent" %}
						<select name="filtres" id="filtresParent" multiple="multiple">
						{% endif %}
	       				
	       				{% for ligne in lignesCSV %}
	       					<option value="{{ligne[numColonne]}}">{{ligne[numColonne]}}</option>
	       				{% endfor %}
	   					</select>
					{% endif %}
				</td>
				{% endfor %}
			</tr>
			
	<!-- Affichage des lignes de données du fichier -->
			
			<script>var lignesErreur = [];//Tableau stockant les lignes ou il y'a des erreurs</script>

			{% for numLigne in range(lignes|int) %}
				{% set ligne = lignesCSV[numLigne+(request.args.get("numPage")|int)*(fullLignes|int)] %}
				<tr>
				<td>{{numLigne+(request.args.get("numPage")|int)*(fullLignes|int) + 1}}</td>
				{% for donnee in ligne %}
					{% if descCSV["erreurs"][numLigne+(request.args.get("numPage")|int)*(fullLignes|int)][loop.index0] != "correct" %}
						<td id="erreur">{{ donnee }} <span>{{descCSV["erreurs"][numLigne+(request.args.get("numPage")|int)*(fullLignes|int)][loop.index0]}}</span></td>
						<script>
							lignesErreur.push(parseInt('{{numLigne+(request.args.get("numPage")|int)*(fullLignes|int) + 1}}'));	//+1 car va etre comparé avec les numéros de la colonne N°
						</script>
					{% else %}
						<td id="valeur">{{ donnee }}</td>
					{% endif %}
				{% endfor %}
				</tr>
			{% endfor %}
			
		</table>
		{% endif %}
		
	</section>

	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-2.1.1.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/multiple-select/multiple-select.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/echantillons.js') }}"></script>
</body>

{% include 'footer.html' %}

</html>